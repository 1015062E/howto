<br>
<table>
<td>WARNING</td>
<td>Please refer to this document with an understanding of the potential risks involved. Proceed at your own discretion.</td>
</table>
<br>

In this post, we'll break down a DAX formula that transforms a user's principal name (UPN) based on their domain. This content is generated by AI to help you understand the logic and application of the formula.

## The DAX Formula

```dax
TransformedUPN = 
VAR InternalDomain = "MngEnvMCAP523303.onmicrosoft.com"  // You need to replace this value with your own
VAR CurrentUPN = USERPRINCIPALNAME()
VAR UserNamePart = LEFT(CurrentUPN, FIND("@", CurrentUPN) - 1)
VAR Domain = MID(CurrentUPN, FIND("@", CurrentUPN) + 1, LEN(CurrentUPN))
RETURN IF(
    Domain <> InternalDomain,
    UserNamePart & "_" & Domain & "#EXT#@" & InternalDomain,
    CurrentUPN
)
```

## Breakdown of the Formula

1. **Declare the Internal Domain**: The internal domain is set as `"MngEnvMCAP523303.onmicrosoft.com"`. You need to replace this value with your own domain.

2. **Extract the Current UPN**: The formula starts by getting the current user's principal name using `USERPRINCIPALNAME()`.

3. **Split the UPN**: It then splits the UPN into two parts:
   - `UserNamePart`: The part before the "@" symbol.
   - `Domain`: The part after the "@" symbol.

4. **Check the Domain**: The formula checks if the user's domain is different from the internal domain.

5. **Transform the UPN**: If the domain is different, it transforms the UPN by appending `#EXT#` to the new UPN format. The new format is `UserNamePart_Domain#EXT#@InternalDomain`.

6. **Return the UPN**: If the domain matches the internal domain, it returns the original UPN.

## Conclusion

This DAX formula is useful for modifying UPNs for external users while keeping the UPN unchanged for internal users. It's a handy way to manage user identities in environments where both internal and external users need to be distinguished.
